# 文字游戏框架 - Text Game Framework
# 这个框架提供了一个简单的文字冒险游戏的基础结构
# This framework provides a basic structure for text-based adventure games

imports:
  - io

classes:
  # 物品类 - Item Class
  # 表示游戏中的物品对象
  Item:
    # 初始化物品 - Initialize item
    init: (name, description) => {
        this.name = name
        this.description = description
      }

    # 获取物品名称 - Get item name
    getName: () => {
        return this.name
      }

    # 获取物品描述 - Get item description
    getDescription: () => {
        return this.description
      }

  # 房间类 - Room Class
  # 表示游戏中的房间或场景
  Room:
    # 初始化房间 - Initialize room
    init: (name, description) => {
        this.name = name
        this.description = description
        this.items = []  # 房间中的物品列表 - List of items in the room
        this.exits = {}  # 出口字典，键为方向，值为房间名称 - Exit dictionary, key is direction, value is room name
      }

    # 添加物品到房间 - Add item to room
    addItem: (item) => {
        this.items = this.items + [item]
      }

    # 从房间移除物品 - Remove item from room
    removeItem: (itemName) => {
        newItems = []
        for (item in this.items) :
          if (item.getName() != itemName) :
            newItems = newItems + [item]
        this.items = newItems
      }

    # 设置出口 - Set exit
    setExit: (direction, roomName) => {
        this.exits[direction] = roomName
      }

    # 获取房间描述 - Get room description
    getDescription: () => {
        desc = this.name + "\n" + this.description + "\n"
        if (len(this.items) > 0) :
          desc = desc + "你看到这里有: "
          first = true
          for (item in this.items) :
            if (!first) :
              desc = desc + ", "
            desc = desc + item.getName()
            first = false
          desc = desc + "\n"
        desc = desc + "出口: " + str(this.exits)
        return desc
      }



    # 检查是否有出口 - Check if exit exists
    hasExit: (direction) => {
        return this.exits[direction] != null
      }

    # 获取出口房间名称 - Get exit room name
    getExit: (direction) => {
        return this.exits[direction]
      }

    # 获取房间名称 - Get room name
    getName: () => {
        return this.name
      }

  # 玩家类 - Player Class

  # 表示游戏中的玩家角色
  Player:
    # 初始化玩家 - Initialize player
    init: (name) => {
        this.name = name
        this.inventory = []  # 玩家背包 - Player inventory
        this.currentRoom = null  # 当前所在房间 - Current room
      }

    # 设置当前位置 - Set current location
    setLocation: (room) => {
        this.currentRoom = room
      }

    # 添加物品到背包 - Add item to inventory
    addItem: (item) => {
        this.inventory = this.inventory + [item]
      }

    # 从背包移除物品 - Remove item from inventory
    removeItem: (itemName) => {
        newInventory = []
        for (item in this.inventory) :
          if (item.getName() != itemName) :
            newInventory = newInventory + [item]
        this.inventory = newInventory
      }

    # 检查是否有物品 - Check if has item
    hasItem: (itemName) => {
        for (item in this.inventory) :
          if (item.getName() == itemName) :
            return true
        return false
      }

    # 显示背包内容 - Show inventory
    showInventory: () => {
        if (len(this.inventory) == 0) :
          return "你的背包是空的。"
        else :
          inv = "你的背包里有: "
          first = true
          for (item in this.inventory) :
            if (!first) :
              inv = inv + ", "
            inv = inv + item.getName()
            first = false
          return inv
      }


  # 命令解析器类 - Command Parser Class
  # 解析用户输入的命令
  CommandParser:
    # 初始化命令解析器 - Initialize command parser
    init: () => {
        this.commands = {
            "go": ["go", "走", "移动"],
            "take": ["take", "拿", "捡起"],
            "drop": ["drop", "扔", "放下"],
            "inventory": ["inventory", "背包", "i"],
            "look": ["look", "看", "观察", "l"],
            "help": ["help", "帮助", "h"],
            "quit": ["quit", "退出", "q"]
          }
      }

    # 解析命令 - Parse command
    parse: (input) => {
        # 安全检查：确保输入有效
        if (input == null) :
          return {"command": "unknown", "args": []}
        
        words = this.splitInput(input)
        if (words == null) :
          return {"command": "unknown", "args": []}
        
        if (len(words) == 0) :
          return {"command": "unknown", "args": []}


        commandWord = words[0]
        args = []
        if (len(words) > 1) :
          i = 1
          while (i < len(words)) :
            args = args + [words[i]]
            i = i + 1

        # 识别命令 - Recognize command
        for (cmd in this.commands) :
          aliases = this.commands[cmd]
          for (alias in aliases) :
            if (alias == commandWord) :
              return {"command": cmd, "args": args}

        return {"command": "unknown", "args": words}
      }

    # 分割输入字符串 - Split input string
    splitInput: (input) => {
        # 简单分割，实际实现可能需要更复杂的解析
        # Simple split, real implementation might need more complex parsing
        words = []
        current = ""
        
        # 检查空输入
        if (input == null) :
          return words
        
        # 确保输入是字符串
        inputStr = str(input)
        
        for (char in inputStr) :
          if (char == " ") :
            if (len(current) > 0) :
              words = words + [current]
              current = ""
          else :
            current = current + char
        if (len(current) > 0) :
          words = words + [current]
        return words
      }




  # 游戏类 - Game Class
  # 管理整个游戏的状态和流程
  Game:
    # 初始化游戏 - Initialize game
    init: () => {
        this.player = null
        this.rooms = []  # 所有房间的列表 - List of all rooms
        this.currentRoom = null
        this.parser = CommandParser()
        this.isRunning = false
      }


    # 设置玩家 - Set player
    setPlayer: (player) => {
        this.player = player
      }

    # 添加房间 - Add room
    addRoom: (room) => {
        this.rooms = this.rooms + [room]
      }

    # 设置起始房间 - Set starting room
    setStartingRoom: (roomName) => {
        for (r in this.rooms) :
          if (r.getName() == roomName) :
            this.currentRoom = r
            this.player.setLocation(this.currentRoom)
            break
      }


    # 开始游戏 - Start game
    start: () => {
        this.isRunning = true
        echo "欢迎来到文字冒险游戏！输入 'help' 查看帮助。"
        echo ""
        this.showCurrentRoom()
        this.gameLoop()
      }

    # 游戏主循环 - Main game loop
    gameLoop: () => {
        while (this.isRunning) :
          echo ""
          userInput = input("> ")
          if (userInput == null || userInput == "") :
            continue
          if (userInput == "quit" || userInput == "q") :
            this.quit()
          else :
            this.processCommand(userInput)
      }


    # 处理命令 - Process command
    processCommand: (input) => {
        parsed = this.parser.parse(input)
        command = parsed["command"]
        args = parsed["args"]

        # 使用 if-else 链处理命令
        if (command == "go") :
          this.doGo(args)
        else :
          if (command == "take") :
            this.doTake(args)
          else :
            if (command == "drop") :
              this.doDrop(args)
            else :
              if (command == "inventory") :
                this.doInventory()
              else :
                if (command == "look") :
                  this.doLook()
                else :
                  if (command == "help") :
                    this.doHelp()
                  else :
                    if (command == "quit") :
                      this.quit()
                    else :
                      echo "我不明白这个命令。输入 'help' 查看可用命令。"
      }

    # 显示帮助 - Show help
    doHelp: () => {
        echo "可用命令："
        echo "  go <方向> - 移动（如：go north, go east）"
        echo "  take <物品> - 拾取物品（如：take 钥匙）"
        echo "  drop <物品> - 放下物品（如：drop 钥匙）"
        echo "  inventory - 查看背包（简写：i）"
        echo "  look - 查看当前房间（简写：l）"
        echo "  help - 显示帮助（简写：h）"
        echo "  quit - 退出游戏（简写：q）"
      }


    # 执行移动命令 - Execute go command
    doGo: (args) => {
        if (len(args) == 0) :
          echo "去哪里？请指定方向。"
          return

        direction = args[0]
        if (this.currentRoom.hasExit(direction)) :
          nextRoomName = this.currentRoom.getExit(direction)
          # 在房间列表中查找目标房间
          for (r in this.rooms) :
            if (r.getName() == nextRoomName) :
              this.currentRoom = r
              this.player.setLocation(this.currentRoom)
              this.showCurrentRoom()
              break
        else :
          echo "那个方向没有出口。"
      }



    # 执行拿取命令 - Execute take command
    doTake: (args) => {
        if (len(args) == 0) :
          echo "拿什么？请指定物品名称。"
          return

        itemName = args[0]
        # 检查房间是否有这个物品 - Check if room has this item
        found = false
        for (item in this.currentRoom.items) :
          if (item.getName() == itemName) :
            this.player.addItem(item)
            this.currentRoom.removeItem(itemName)
            echo "你捡起了 " + itemName + "。"
            found = true
            break

        if (!found) :
          echo "这里没有 " + itemName + "。"
      }

    # 执行放下命令 - Execute drop command
    doDrop: (args) => {
        if (len(args) == 0) :
          echo "放下什么？请指定物品名称。"
          return

        itemName = args[0]
        if (this.player.hasItem(itemName)) :
          # 从玩家背包移除并添加到房间 - Remove from player inventory and add to room
          for (item in this.player.inventory) :
            if (item.getName() == itemName) :
              this.currentRoom.addItem(item)
              break
          this.player.removeItem(itemName)
          echo "你放下了 " + itemName + "。"
        else :
          echo "你没有 " + itemName + "。"
      }

    # 执行查看背包命令 - Execute inventory command
    doInventory: () => {
        echo this.player.showInventory()
      }

    # 执行查看命令 - Execute look command
    doLook: () => {
        this.showCurrentRoom()
      }

    # 显示当前房间 - Show current room
    showCurrentRoom: () => {
        echo this.currentRoom.getDescription()
      }

    # 退出游戏 - Quit game
    quit: () => {
        echo "感谢游玩！再见！"
        this.isRunning = false
      }

# 创建游戏实例和示例世界 - Create game instance and example world
objects:
  game: Game()
  player: Player("冒险者")

# 示例房间和物品 - Example rooms and items
objects:
  livingRoom: Room("客厅", "这是一个舒适的客厅，有一张沙发和一张咖啡桌。")
  kitchen: Room("厨房", "厨房里有一张餐桌和一些厨具。")
  bedroom: Room("卧室", "卧室里有一张大床和一个衣柜。")

  key: Item("钥匙", "一把闪闪发光的金钥匙")
  book: Item("书", "一本古老的魔法书")

# 设置游戏世界 - Set up game world
main: () => {
    # 添加房间到游戏 - Add rooms to game
    game.addRoom(livingRoom)
    game.addRoom(kitchen)
    game.addRoom(bedroom)

    # 设置房间出口 - Set room exits
    livingRoom.setExit("north", "厨房")
    livingRoom.setExit("east", "卧室")
    kitchen.setExit("south", "客厅")
    bedroom.setExit("west", "客厅")

    # 添加物品到房间 - Add items to rooms
    livingRoom.addItem(key)
    kitchen.addItem(book)

    # 设置玩家和起始位置 - Set player and starting position
    game.setPlayer(player)
    game.setStartingRoom("客厅")

    # 开始游戏 - Start game
    game.start()
  }

call: main()
